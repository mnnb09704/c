<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Work & Earn</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* General Styles */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; -webkit-user-select: none; user-select: none; overflow-x: hidden; }
        .container { max-width: 500px; margin: 0 auto; padding-bottom: 70px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: #0088cc; color: white; position: fixed; top: 0; width: 100%; max-width: 500px; box-sizing: border-box; z-index: 100; }
        .header .logo { font-weight: bold; font-size: 1.2em; }
        .header .icons button { background: none; border: none; color: white; font-size: 24px; margin-left: 15px; cursor: pointer; padding: 5px; }
        .nav-bottom { display: flex; justify-content: space-around; padding: 5px 0; background-color: white; border-top: 1px solid #eee; position: fixed; bottom: 0; width: 100%; max-width: 500px; box-sizing: border-box; z-index: 100; }
        .nav-bottom button { background: none; border: none; color: #555; font-size: 12px; display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 5px 10px; flex-grow: 1; }
        .nav-bottom button.active { color: #0088cc; }
        .nav-bottom button .material-icons { font-size: 24px; margin-bottom: 2px; }
        .page { display: none; padding: 70px 15px 15px; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        #authPage .input-group { margin-bottom: 15px; }
        #authPage label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        #authPage input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        #authPage .password-container { position: relative; }
        #authPage .password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #888; }
        #authPage button.submit-btn { width: 100%; background-color: #0088cc; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin-top: 10px; }
        #authPage p { text-align: center; margin-top: 20px; }
        #authPage a { color: #0088cc; text-decoration: none; font-weight: bold; }
        .welcome-banner { background: linear-gradient(45deg, #0088cc, #00b3ee); color: white; text-align: center; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
        .welcome-banner h2 { margin: 0; }
        .profile-header { text-align: center; }
        .profile-pic-container { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; position: relative; }
        .profile-pic-container img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid #0088cc; }
        .logout-button { width: 100%; background-color: #dc3545; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin-top: 20px; }
        .balance-card { text-align: center; background: linear-gradient(45deg, #2a2a72, #009ffd); color: white; }
        .balance-amount { font-size: 2.5em; font-weight: bold; margin: 10px 0 0 0; }
        .withdraw-input-group { margin-bottom: 15px; }
        .withdraw-input-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; color: #555; }
        .withdraw-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .withdraw-btn { width: 100%; background-color: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin-top: 10px; }
        .payment-method-header { display: flex; align-items: center; margin-bottom: 15px; }
        .payment-logo { width: 30px; height: 30px; margin-right: 10px; border-radius: 5px; }
        .task-card { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .task-card:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .task-title { font-weight: bold; font-size: 1.1em; }
        .task-desc { color: #555; margin: 8px 0; }
        .task-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .task-reward { font-weight: bold; color: green; }
        .task-button { background-color: #0088cc; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="appContainer">
        <div class="header" style="display: none;">
            <span class="logo">Work & Earn</span>
            <div class="icons"><button id="profileButton"><i class="material-icons">person</i></button></div>
        </div>

        <div class="container">
            <div id="authPage" class="page">
                <div class="card" style="margin-top: 30px;">
                    <h2 id="authTitle" style="text-align: center;">Welcome Back!</h2>
                    <div id="loginForm">
                        <div class="input-group"><label for="loginEmail">Email</label><input type="email" id="loginEmail" placeholder="your@email.com"></div>
                        <div class="input-group"><label for="loginPassword">Password</label><div class="password-container"><input type="password" id="loginPassword" placeholder="••••••••"><button class="password-toggle" type="button"><i class="material-icons">visibility</i></button></div></div>
                        <button class="submit-btn" id="loginBtn">Log In</button>
                        <p>Don't have an account? <a href="#" id="showSignupLink">Signup here</a></p>
                    </div>
                    <div id="signupForm" style="display: none;">
                        <div class="input-group"><label for="signupFullName">Full Name</label><input type="text" id="signupFullName" placeholder="John Doe"></div>
                        <div class="input-group"><label for="signupEmail">Email</label><input type="email" id="signupEmail" placeholder="your@email.com"></div>
                        <div class="input-group"><label for="signupPassword">Password</label><div class="password-container"><input type="password" id="signupPassword" placeholder="••••••••"><button class="password-toggle" type="button"><i class="material-icons">visibility</i></button></div></div>
                        <button class="submit-btn" id="signupBtn">Sign Up</button>
                        <p>Already have an account? <a href="#" id="showLoginLink">Login here</a></p>
                    </div>
                </div>
            </div>

            <div id="homePage" class="page"><div class="welcome-banner"><h2 id="welcomeMessage">Hello, User!</h2></div></div>

            <div id="workPage" class="page">
                <h2>Task Board</h2>
                <div id="task-board-container" class="card"><p>Loading tasks...</p></div>
            </div>

            <div id="withdrawPage" class="page">
                <h2>Withdraw Funds</h2>
                <div class="card balance-card"><h4>Your Current Balance</h4><p id="balanceAmount" class="balance-amount">0 Coins</p></div>
                <div class="card">
                    <div class="payment-method-header"><img src="https://i.ibb.co/c2R9S2V/bkash.png" alt="Bkash" class="payment-logo"><h3>Withdraw via Bkash</h3></div>
                    <div class="withdraw-input-group"><label for="bkashAmount">Amount (Coins)</label><input type="number" id="bkashAmount" class="withdraw-input" placeholder="e.g., 500"></div>
                    <div class="withdraw-input-group"><label for="bkashNumber">Your Bkash Number</label><input type="text" id="bkashNumber" class="withdraw-input" placeholder="e.g., 01700000000"></div>
                    <button class="withdraw-btn" onclick="window.handleWithdrawalRequest('Bkash')">Request Withdrawal</button>
                </div>
            </div>

            <div id="profilePage" class="page">
                <div class="card profile-header">
                    <div class="profile-pic-container"><img id="profileImage" src="https://via.placeholder.com/100" alt="Profile Picture"></div>
                    <h2 id="profileName">User</h2>
                    <p id="profileEmail">email@example.com</p>
                </div>
                <button class="logout-button" id="logoutBtn">Logout</button>
            </div>
        </div>

        <div class="nav-bottom" style="display: none;">
            <button class="nav-btn active" data-page="home"><i class="material-icons">home</i>Home</button>
            <button class="nav-btn" data-page="work"><i class="material-icons">work</i>Work</button>
            <button class="nav-btn" data-page="withdraw"><i class="material-icons">account_balance_wallet</i>Withdraw</button>
        </div>
    </div>

    <script type="module">
        // ============================== FIREBASE CONFIG ==============================
        const firebaseConfig = {
             apiKey: "AIzaSyAQG6aZY3kaleNFi2vdR5_FPk8fHnI8kRk",
             authDomain: "income-hobei.firebaseapp.com",
             projectId: "income-hobei",
             storageBucket: "income-hobei.firebasestorage.app",
             messagingSenderId: "87846212742",
             appId: "1:87846212742:web:6b5961db7f2a7df3932d07"
        };

        // ========================== FIREBASE SDK IMPORTS (v9) ==========================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, serverTimestamp, query, where, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ============================= INITIALIZATION =============================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ========================== DOM ELEMENT REFERENCES & STATE ==========================
        const header = document.querySelector('.header');
        const navBottom = document.querySelector('.nav-bottom');
        let currentUser = null;
        let currentUserData = null;
        let unsubscribeUser; // To stop Firestore listener on logout

        // =============================== CORE FUNCTIONS ===============================
        
        /**
         * Displays a specific page by ID and hides others.
         * @param {string} pageId - The ID of the page to show (e.g., 'home', 'auth').
         */
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = document.getElementById(pageId + 'Page');
            if (page) {
                page.classList.add('active');
            }
        };

        /**
         * Main authentication state listener. Handles user login, logout, and session state.
         */
        onAuthStateChanged(auth, async (user) => {
            if (unsubscribeUser) {
                unsubscribeUser(); // Stop listening to previous user's data
            }
            
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                // Check if user is blocked
                if (userDoc.exists() && userDoc.data().isBlocked === true) {
                    alert('Your account has been blocked by an administrator.');
                    await signOut(auth);
                    return;
                }

                // If new user, create their document in Firestore
                if (!userDoc.exists()) {
                    await setDoc(userDocRef, {
                        name: user.displayName || 'N/A',
                        email: user.email,
                        balance: 0,
                        isBlocked: false,
                        createdAt: serverTimestamp()
                    });
                }
                
                // Listen for real-time updates to the user's data (like balance changes)
                unsubscribeUser = onSnapshot(userDocRef, (doc) => {
                    currentUserData = doc.data();
                    updateBalanceUI();
                });
                
                currentUser = user;
                initAppAfterAuth(user);
            } else {
                // User is logged out
                currentUser = null;
                currentUserData = null;
                header.style.display = 'none';
                navBottom.style.display = 'none';
                showPage('auth');
            }
        });

        /**
         * Initializes the main application view after a successful login.
         * @param {object} user - The authenticated user object from Firebase.
         */
        function initAppAfterAuth(user) {
            header.style.display = 'flex';
            navBottom.style.display = 'flex';
            updateProfileUI(user);
            loadTasksForUser();
            // Programmatically click the home button to ensure correct page and active state
            document.querySelector('.nav-btn[data-page="home"]').click();
        }

        // =========================== AUTHENTICATION HANDLERS ===========================

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) return alert('Please enter email and password.');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert(`Login Failed: ${error.message}`);
            }
        };

        async function handleSignup() {
            const fullName = document.getElementById('signupFullName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            if (!fullName || !email || !password) return alert('Please fill all fields.');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Set user's display name
                await updateProfile(userCredential.user, { displayName: fullName });
                // onAuthStateChanged will handle creating the Firestore document
            } catch (error) {
                alert(`Signup Failed: ${error.message}`);
            }
        };
        
        // =========================== FEATURE-SPECIFIC FUNCTIONS ===========================

        /**
         * Handles withdrawal requests from the user.
         * @param {string} method - The payment method (e.g., 'Bkash').
         */
        window.handleWithdrawalRequest = async (method) => {
            if (!currentUser) return alert("Please log in first.");
            
            const amountEl = document.getElementById(`${method.toLowerCase()}Amount`);
            const accountEl = document.getElementById(`${method.toLowerCase()}Number`);
            const amount = parseFloat(amountEl.value);
            const account = accountEl.value.trim();
            
            if (!account || isNaN(amount) || amount <= 0) return alert('Please enter a valid amount and details.');
            if (!currentUserData || currentUserData.balance < amount) return alert("Insufficient balance for this withdrawal.");
            
            try {
                // 1. Add request to 'withdrawals' collection
                await addDoc(collection(db, "withdrawals"), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email,
                    amount,
                    method,
                    paymentDetail: account,
                    status: 'pending',
                    requestedAt: serverTimestamp()
                });
                
                // 2. Deduct amount from user's balance
                const userRef = doc(db, "users", currentUser.uid);
                const newBalance = currentUserData.balance - amount;
                await updateDoc(userRef, { balance: newBalance });
                
                alert('Your withdrawal request has been submitted successfully!');
                amountEl.value = '';
                accountEl.value = '';
            } catch (error) {
                alert(`Request failed: ${error.message}`);
            }
        };

        /**
         * Loads and displays active tasks from Firestore.
         */
        function loadTasksForUser() {
            const taskBoard = document.getElementById('task-board-container');
            const q = query(collection(db, "tasks"), where("isActive", "==", true));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    taskBoard.innerHTML = '<p>No tasks available right now. Please check back later.</p>';
                    return;
                }
                taskBoard.innerHTML = '';
                snapshot.forEach(doc => {
                    const task = doc.data();
                    taskBoard.innerHTML += `<div class="task-card">
                        <h3 class="task-title">${task.title}</h3><p class="task-desc">${task.description}</p>
                        <div class="task-footer"><span class="task-reward">Reward: ${task.reward} Coins</span>
                        <button class="task-button" data-task-id="${doc.id}" data-reward="${task.reward}">Complete</button></div></div>`;
                });
            });
        }
        
        /**
         * Handles the completion of a task and updates the user's balance.
         * @param {string} taskId - The ID of the completed task.
         * @param {number} reward - The reward amount for the task.
         */
        async function completeTask(taskId, reward) {
            if (!currentUser) return alert("Please log in.");
            
            // In a real app, you might want to verify task completion here.
            
            const userRef = doc(db, "users", currentUser.uid);
            try {
                const newBalance = (currentUserData.balance || 0) + reward;
                await updateDoc(userRef, { balance: newBalance });
                alert(`Congratulations! You have earned ${reward} coins.`);
            } catch (e) {
                alert("Failed to update balance. Please try again.");
            }
        };

        // =============================== UI UPDATE & HELPER FUNCTIONS ===============================
        
        /**
         * Updates the profile page UI with user's info.
         * @param {object} user - The authenticated user object.
         */
        function updateProfileUI(user) {
            document.getElementById('welcomeMessage').innerText = `Hello, ${user.displayName || 'User'}!`;
            document.getElementById('profileName').innerText = user.displayName || 'User';
            document.getElementById('profileEmail').innerText = user.email;
        }

        /**
         * Updates the balance display on the withdrawal page.
         */
        function updateBalanceUI() {
            if (currentUserData) {
                document.getElementById('balanceAmount').textContent = `${currentUserData.balance || 0} Coins`;
            }
        }
        
        // =========================== EVENT LISTENERS SETUP ===========================
        
        // Navigation buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const pageId = e.currentTarget.dataset.page;
                showPage(pageId);
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
            });
        });
        
        // Profile button in header
        document.getElementById('profileButton').addEventListener('click', () => {
            showPage('profile');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        });

        // Auth buttons
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('signupBtn').addEventListener('click', handleSignup);
        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
        
        // Task completion listener (using event delegation)
        document.getElementById('task-board-container').addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('task-button')) {
                const taskId = e.target.dataset.taskId;
                const reward = parseInt(e.target.dataset.reward);
                completeTask(taskId, reward);
            }
        });
        
        // Links to switch between Login and Signup forms
        document.getElementById('showSignupLink').addEventListener('click', (e) => { 
            e.preventDefault();
            document.getElementById('loginForm').style.display = 'none'; 
            document.getElementById('signupForm').style.display = 'block'; 
            document.getElementById('authTitle').innerText = 'Create Your Account'; 
        });
        document.getElementById('showLoginLink').addEventListener('click', (e) => { 
            e.preventDefault();
            document.getElementById('loginForm').style.display = 'block'; 
            document.getElementById('signupForm').style.display = 'none'; 
            document.getElementById('authTitle').innerText = 'Welcome Back!'; 
        });

        // Password visibility toggles
        document.querySelectorAll('.password-toggle').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const input = e.currentTarget.previousElementSibling;
                const icon = e.currentTarget.querySelector('i');
                input.type = input.type === 'password' ? 'text' : 'password';
                icon.innerText = input.type === 'password' ? 'visibility' : 'visibility_off';
            });
        });
        
        // Initial page to show
        showPage('auth');
    </script>
</body>
</html>
