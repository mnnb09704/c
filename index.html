<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>all script</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap');
        :root {
            --color-bg: #0d0c22;
            --color-surface: #191932;
            --color-card: #232342;
            --color-primary: #00f6ff;
            --color-secondary: #ff00f8;
            --color-glow: rgba(0, 246, 255, 0.3);
        }
        body {
            font-family: 'Inter', 'Noto Sans Bengali', sans-serif;
            background-color: var(--color-bg);
            color: #ffffff;
        }
        .bg-surface { background-color: var(--color-surface); }
        .bg-card { background-color: var(--color-card); }
        .text-primary { color: var(--color-primary); }
        .btn-primary {
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 0 15px var(--color-glow);
        }
        .btn-primary:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--color-glow); }
        .btn-primary:disabled { background: #555; cursor: not-allowed; box-shadow: none; }
        .card-glow {
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        .card-glow:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2), 0 0 15px var(--color-glow);
        }
        .modal { display: none; }
        .modal.show { display: flex; }
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
            color: var(--color-bg);
            padding: 14px 28px;
            border-radius: 8px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            transform: translate(-50%, 20px);
            font-weight: 600;
            box-shadow: 0 0 20px var(--color-glow);
        }
        .toast.show { opacity: 1; transform: translate(-50%, 0); }
        .step-indicator.active { background-color: var(--color-primary); color: var(--color-bg); }
        .payment-option { border: 2px solid #4a4a4a; transition: all 0.3s ease; }
        .payment-option.selected { border-color: var(--color-primary); box-shadow: 0 0 10px var(--color-glow); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .horizontal-scroll {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding-bottom: 1rem;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .horizontal-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        .horizontal-scroll .product-card {
            width: 45%;
            flex-shrink: 0;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .horizontal-scroll .product-card {
                width: 30%;
            }
        }
        .telegram-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            background-color: #2AABEE;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        .telegram-fab:hover {
            transform: scale(1.1);
        }

    </style>
</head>
<body class="bg-surface">

    <div id="toast" class="toast"></div>

    <div class="max-w-screen-md mx-auto p-4">
        <header class="flex justify-between items-center mb-6">
            <h1 id="home-btn" class="text-2xl font-extrabold cursor-pointer tracking-wider" style="text-shadow: 0 0 10px var(--color-glow);">ALL SCRIPT</h1>
            <div class="flex items-center gap-2 sm:gap-4">
                <button id="search-icon" class="p-2 rounded-full hover:bg-card transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></button>
                <button id="cart-btn" class="relative p-2 rounded-full hover:bg-card transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.19.988.707.988H19m-9-6h2m-2 4h2" /></svg><span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span></button>
                <button id="my-products-button" title="আমার কেনা পণ্য" class="p-2 rounded-full hover:bg-card transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0v10l-8 4-8-4V7m16 0l-8 4-8-4" /></svg></button>
                <button id="sell-to-us-button" title="আমাদের কাছে বেচুন" class="p-2 rounded-full hover:bg-card transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </button>
            </div>
        </header>
        
        <div id="initial-error" class="hidden p-4 mb-4 text-center bg-red-800 text-white rounded-lg"></div>

        <section id="search-section" class="hidden mb-6">
            <input type="text" id="search-input" placeholder="Search products..." class="w-full p-3 rounded-lg bg-card border border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary">
            <div id="search-results" class="mt-4 text-center text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg><p>Type to find scripts and games.</p></div>
        </section>

        <main id="main-content"><div class="h-64 flex justify-center items-center"><div class="loader"></div></div></main>
    </div>

    <!-- Telegram Floating Action Button -->
    <!-- IMPORTANT: Replace "YOUR_TELEGRAM_USERNAME" with your actual Telegram username -->
    <a href="https://t.me/YOUR_TELEGRAM_USERNAME" target="_blank" class="telegram-fab" title="Contact on Telegram">
        <svg xmlns="https://t.me/allscriptandtools" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
            <path d="M22 2L11 13H11L2 6.5L22 2ZM2 8.5L9 12L2 17L2 8.5Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDocs, setDoc, addDoc, onSnapshot, collection, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCiV4AjrQ8XWrAygsagNiO5MNNcG0efpTs",
            authDomain: "digital-2313a.firebaseapp.com",
            databaseURL: "https://digital-2313a-default-rtdb.firebaseio.com",
            projectId: "digital-2313a",
            storageBucket: "digital-2313a.appspot.com",
            messagingSenderId: "391359795549",
            appId: "1:391359795549:web:2616455e966f3bf6a658b4",
            measurementId: "G-8N8VDT2BNK"
        };
        const appId = "1:391359795549:web:2616455e966f3bf6a658b4";

        let db;
        let auth;
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            document.getElementById('initial-error').textContent = "Firebase কনফিগারেশন সঠিক নয়।";
            document.getElementById('initial-error').classList.remove('hidden');
        }

        let products = [];
        let sections = [];
        let bannerSettings = {};
        let wantedItems = [];
        
        let cart = [];
        const checkoutState = { step: 1, customerInfo: {}, paymentMethod: null, appliedCoupon: null };
        const paymentDetails = {
            bkash: { name: 'bKash', number: '01722051341' },
            nagad: { name: 'Nagad', number: '01722051341' },
            usdt: { name: 'USDT (BEP20)', address: '0xada2c9e160ea04710ea1dcb8623234f6700ab9c1' }
        };

        const mainContent = document.getElementById('main-content');
        const searchSection = document.getElementById('search-section');
        const searchInput = document.getElementById('search-input');
        
        const ProductCardHTML = (p) => `
            <div class="product-card cursor-pointer" data-id="${p.id}">
                <div class="bg-card p-4 rounded-2xl relative card-glow h-full flex flex-col">
                    <img src="${p.image}" alt="${p.name}" class="w-full h-32 object-cover rounded-lg mb-3">
                    <div class="flex-grow">
                        <h3 class="font-semibold text-lg truncate">${p.name}</h3>
                        <p class="text-xs text-gray-400">${p.category || ''}</p>
                    </div>
                    ${p.stock === 0 
                        ? `<p class="text-sm text-red-400 font-bold mt-1">Out of Stock</p><span class="absolute top-2 right-2 text-xs bg-red-600 text-white px-2 py-1 rounded-full font-bold">Sold Out</span>` 
                        : `<p class="text-lg font-bold text-primary mt-1">$${p.price.toFixed(2)}</p>`
                    }
                </div>
            </div>
        `;

        const HomePage = (banner) => `
            <div class="space-y-8">
                <div class="bg-gradient-to-r from-cyan-500 to-pink-500 p-8 rounded-2xl shadow-lg text-white text-center card-glow">
                    <h2 class="text-3xl font-extrabold tracking-wider">${banner?.title || 'WELCOME OFFER'}</h2>
                    <p class="mt-2 text-lg">${banner?.subtitle || 'Use code below for 10% OFF!'}</p>
                    <div class="mt-4 inline-block bg-white text-black font-mono px-4 py-2 rounded-lg font-bold text-lg">${banner?.coupon || 'WELCOME10'}</div>
                </div>
                <div id="home-sections-container" class="space-y-8">
                </div>
            </div>`;
        
        const SectionPage = (sectionName, productsInSection) => `
            <div class="mb-4"><button class="back-btn text-gray-400">&larr; Back</button></div>
            <h2 class="text-3xl font-bold mb-6">${sectionName}</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-6">
                ${productsInSection.map(p => ProductCardHTML(p)).join('')}
            </div>
        `;

        const ProductDetailPage = (product) => `
            <div class="mb-4"><button class="back-btn text-gray-400">&larr; Back</button></div>
            <div class="bg-card rounded-2xl p-6 text-center card-glow">
                <img src="${product.image}" alt="${product.name}" class="w-40 h-40 rounded-lg mx-auto mb-6 shadow-lg">
                <h1 class="text-3xl font-bold">${product.name}</h1>
                 <p class="text-sm text-gray-400 mt-1">${product.category || ''}</p>
                <div class="my-8">
                    <h2 class="font-bold text-lg mb-3 text-primary">Features</h2>
                    <ul class="space-y-2 text-gray-300 text-left list-disc list-inside">
                        ${(product.features && Array.isArray(product.features) ? product.features : []).map(f => `<li>${f}</li>`).join('')}
                    </ul>
                </div>
                ${product.stock === 0 
                    ? `<button class="w-full p-3 rounded-lg bg-gray-600 text-gray-400 cursor-not-allowed uppercase font-bold">Out of Stock</button>`
                    : `<div class="flex gap-4">
                            <button class="add-to-cart-btn w-full p-3 rounded-full bg-gray-600 hover:bg-gray-500 font-bold" data-id="${product.id}">Add to Cart</button>
                            <button class="buy-now-btn btn-primary w-full" data-id="${product.id}">Buy Now</button>
                        </div>`
                }
            </div>`;
        
        const CartPage = () => `
            <div class="mb-4"><button class="back-btn text-gray-400">&larr; Back</button></div>
            <h2 class="text-2xl font-bold mb-6">Shopping Cart</h2>
            <div id="cart-items-container" class="space-y-4"></div>`;
            
        const SellToUsPage = (wantedItems) => `
            <div class="mb-4"><button class="back-btn text-gray-400">&larr; Back</button></div>
            <h2 class="text-3xl font-bold mb-6">আমাদের কাছে বিক্রি করুন</h2>
            <p class="text-gray-400 mb-6">আমরা বর্তমানে এই আইটেমগুলো কিনছি। আপনার কাছে থাকলে, আমাদের কাছে বিক্রি করতে পারেন।</p>
            <div id="wanted-items-container" class="space-y-4">
                ${wantedItems.length > 0 ? wantedItems.map(item => `
                    <div class="bg-card p-4 rounded-lg flex items-center gap-4 card-glow">
                        <img src="${item.image}" alt="${item.name}" class="w-20 h-20 rounded-lg object-cover">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold">${item.name}</h3>
                            <p class="text-gray-400 text-sm mt-1">${item.description || ''}</p>
                            <p class="text-primary font-bold text-lg mt-2">আমরা কিনছি: $${item.price.toFixed(2)}</p>
                        </div>
                        <button class="sell-now-btn btn-primary !py-2 !px-4" data-id="${item.id}">এখনই বেচুন</button>
                    </div>
                `).join('') : '<p class="text-center text-gray-500 py-8">বর্তমানে আমরা কিছু কিনছি না।</p>'}
            </div>
        `;

        const SellFormPage = (item) => `
            <div class="mb-4"><button class="back-btn text-gray-400">&larr; Back</button></div>
            <h2 class="text-3xl font-bold mb-2">আপনার "${item.name}" বিক্রি করুন</h2>
            <p class="text-gray-400 mb-6">নিচের ফর্মটি পূরণ করে আপনার বিক্রির অনুরোধ জমা দিন। আমরা ২৪ ঘণ্টার মধ্যে আপনার সাথে যোগাযোগ করব।</p>
            <div id="sell-form-error" class="hidden p-3 bg-red-800 text-white rounded-md text-center mb-4"></div>
            <div class="bg-card rounded-2xl p-6">
                <div class="space-y-4">
                    <div><label class="block mb-1 text-sm text-gray-400">আপনার পুরো নাম</label><input type="text" id="sell-full-name" placeholder="নাম লিখুন" class="w-full p-3 rounded-lg bg-surface border border-gray-600"></div>
                    <div><label class="block mb-1 text-sm text-gray-400">আপনার যোগাযোগের নম্বর (bKash/Nagad)</label><input type="text" id="sell-contact-number" placeholder="যোগাযোগের নম্বর" class="w-full p-3 rounded-lg bg-surface border border-gray-600"></div>
                    <div><label class="block mb-1 text-sm text-gray-400">ফাইল/ছবির লিংক (ঐচ্ছিক)</label><input type="url" id="sell-item-link" placeholder="ফাইলটি Google Drive/Imgur এ আপলোড করে লিংক দিন" class="w-full p-3 rounded-lg bg-surface border border-gray-600"></div>
                    <div><label class="block mb-1 text-sm text-gray-400">আপনার পণ্যের বিবরণ/শর্ত</label><textarea id="sell-item-details" placeholder="আপনার পণ্যের অবস্থা সম্পর্কে লিখুন..." class="w-full p-3 rounded-lg bg-surface border border-gray-600 h-24"></textarea></div>
                    <button id="submit-sell-request-btn" class="btn-primary w-full mt-4" data-item-id="${item.id}" data-item-name="${item.name}" data-item-price="${item.price}">অনুরোধ জমা দিন</button>
                </div>
            </div>
        `;

        const CheckoutPage = () => `
            <div class="mb-4"><button class="back-btn text-gray-400">&larr; Back</button></div>
            <h2 class="text-2xl font-bold mb-6">Checkout</h2>
            <div class="flex justify-between items-center mb-8">
                <div class="flex-1 text-center"><div id="step-1-indicator" class="step-indicator active w-8 h-8 mx-auto rounded-full flex items-center justify-center font-bold">1</div><p class="text-xs mt-1">তথ্য</p></div><div class="flex-1 h-px bg-gray-600"></div>
                <div class="flex-1 text-center"><div id="step-2-indicator" class="step-indicator w-8 h-8 mx-auto rounded-full bg-gray-700 flex items-center justify-center font-bold">2</div><p class="text-xs mt-1 text-gray-500">পেমেন্ট</p></div><div class="flex-1 h-px bg-gray-600"></div>
                <div class="flex-1 text-center"><div id="step-3-indicator" class="step-indicator w-8 h-8 mx-auto rounded-full bg-gray-700 flex items-center justify-center font-bold">3</div><p class="text-xs mt-1 text-gray-500">নিশ্চিতকরণ</p></div>
            </div>
            <div id="checkout-error" class="hidden p-3 bg-red-800 text-white rounded-md text-center mb-4"></div>
            <div class="bg-card rounded-2xl p-6">
                <div id="checkout-step-1">
                    <div class="space-y-4">
                        <div><label class="block mb-1 text-sm text-gray-400">আপনার পুরো নাম</label><input type="text" id="full-name" placeholder="নাম লিখুন" class="w-full p-3 rounded-lg bg-surface border border-gray-600"></div>
                        <div><label class="block mb-1 text-sm text-gray-400">আপনার ইমেইল</label><input type="email" id="email" placeholder="ইমেইল লিখুন" class="w-full p-3 rounded-lg bg-surface border border-gray-600"></div>
                        <div><label class="block mb-1 text-sm text-gray-400">কুপন কোড (ঐচ্ছিক)</label><div class="flex gap-2"><input type="text" id="coupon-code" placeholder="WELCOME10" class="w-full p-3 rounded-lg bg-surface border border-gray-600"><button id="apply-coupon-btn" class="bg-gray-600 px-4 rounded-lg">Apply</button></div><p id="coupon-message" class="text-sm mt-2"></p></div>
                        <button id="checkout-next-1" class="btn-primary w-full mt-4">পরবর্তী ধাপ</button>
                    </div>
                </div>
                <div id="checkout-step-2" class="hidden"><h3 class="font-bold mb-4">পেমেন্ট পদ্ধতি বাছাই করুন</h3><div class="space-y-3"><div class="payment-option p-4 rounded-lg cursor-pointer" data-method="bkash"><h4 class="font-bold">bKash</h4><p class="text-sm text-gray-400">বিকাশের মাধ্যমে পেমেন্ট করুন</p></div><div class="payment-option p-4 rounded-lg cursor-pointer" data-method="nagad"><h4 class="font-bold">Nagad</h4><p class="text-sm text-gray-400">নগদের মাধ্যমে পেমেন্ট করুন</p></div><div class="payment-option p-4 rounded-lg cursor-pointer" data-method="usdt"><h4 class="font-bold">USDT (TRC20)</h4><p class="text-sm text-gray-400">ক্রিপ্টোর মাধ্যমে পেমেন্ট করুন</p></div></div><button id="checkout-next-2" class="btn-primary w-full mt-6">পরবর্তী ধাপ</button></div>
                <div id="checkout-step-3" class="hidden"></div>
            </div>`;
        
        const MyProductsPage = () => `
            <div class="mb-4"><button class="back-btn text-gray-400">&larr; Back</button></div>
            <h2 class="text-2xl font-bold mb-6">আমার কেনা পণ্য</h2>
            <div class="bg-card p-6 rounded-lg">
                <p class="text-gray-400 mb-4">আপনার কেনা পণ্যগুলো দেখতে, কেনাকাটার সময় যে ইমেইলটি ব্যবহার করেছিলেন সেটি নিচে দিন।</p>
                <div class="flex gap-2">
                    <input type="email" id="my-products-email" placeholder="আপনার ইমেইল দিন" class="w-full p-3 rounded-lg bg-surface border border-gray-600">
                    <button id="find-my-products-btn" class="btn-primary">খুঁজুন</button>
                </div>
                <div id="my-products-list" class="mt-6"></div>
            </div>
        `;
        
        const render = async (pageTemplate, ...args) => {
            mainContent.innerHTML = await pageTemplate(...args);
        };

        const renderHomePageSections = () => {
            const container = document.getElementById('home-sections-container');
            if (!container || sections.length === 0) return;

            const sortedSections = [...sections].sort((a, b) => (a.order || 99) - (b.order || 99));
            
            container.innerHTML = sortedSections.map(section => {
                const sectionProducts = products.filter(p => p.sectionId === section.id);
                if (sectionProducts.length === 0) return ''; 

                return `
                    <div>
                        <div class="flex justify-between items-center mb-4">
                           <h2 class="text-2xl font-bold">${section.name}</h2>
                           <button class="view-all-btn text-primary text-sm font-semibold hover:underline" data-section-id="${section.id}" data-section-name="${section.name}">সবগুলো দেখুন &rarr;</button>
                        </div>
                        <div class="horizontal-scroll">
                            ${sectionProducts.map(p => ProductCardHTML(p)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        const updateCartPage = () => {
            const container = document.getElementById('cart-items-container');
            if (!container) return;
            if (cart.length === 0) {
                container.innerHTML = `<div class="text-center p-8 text-gray-400 bg-card rounded-lg">Your Cart is Empty</div>`; return;
            }
            const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            container.innerHTML = `${cart.map(item => `<div class="flex items-center gap-4 bg-card p-3 rounded-lg"><img src="${item.image}" class="w-16 h-16 rounded-lg"><div class="flex-1"><h4 class="font-semibold">${item.name}</h4><p class="text-sm text-primary font-bold">$${item.price.toFixed(2)}</p></div><button class="remove-from-cart-btn text-red-400 hover:text-red-300" data-id="${item.id}">🗑️</button></div>`).join('')}<div class="border-t border-gray-700 pt-4 mt-4 space-y-2"><div class="flex justify-between"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div><div class="flex justify-between font-bold text-xl"><span>Total</span><span>$${subtotal.toFixed(2)}</span></div></div><button id="proceed-to-checkout-btn" class="btn-primary w-full mt-6">Proceed to Checkout</button>`;
        };

        let navigationStack = [];
        const navigate = (page, data) => {
            const currentState = { page, data };
            const lastState = navigationStack[navigationStack.length - 1];

            if (!lastState || lastState.page !== page || JSON.stringify(lastState.data) !== JSON.stringify(data)) {
                 if (page === 'home') {
                     navigationStack = [currentState];
                 } else {
                     navigationStack.push(currentState);
                 }
            }
            
            searchSection.classList.add('hidden');
            mainContent.classList.remove('hidden');

            if (page === 'home') {
                render(HomePage, bannerSettings).then(() => {
                    renderHomePageSections();
                });
            } else if (page === 'section') {
                if (!data || !data.id) {
                    showToast("Error: Section ID missing.");
                    navigate('home', null);
                    return;
                }
                const productsInSection = products.filter(p => p.sectionId === data.id);
                render(SectionPage, data.name, productsInSection);
            } else if (page === 'product-detail') {
                 if (!data || !data.id) {
                     showToast("Error: Product ID missing.");
                     navigate('home', null);
                     return;
                 }
                const product = products.find(p => p.id === data.id);
                 if (product) {
                     render(ProductDetailPage, product);
                 } else {
                     showToast("Error: Product not found!");
                     goBack();
                 }
            }
            else if (page === 'cart') {
                render(CartPage).then(() => updateCartPage());
            }
            else if (page === 'checkout') { 
                checkoutState.step = 1; 
                render(CheckoutPage);
            }
            else if (page === 'my-products') {
                render(MyProductsPage);
            } else if (page === 'sell-to-us') {
                render(SellToUsPage, wantedItems);
            } else if (page === 'sell-form') {
                if (!data || !data.id) {
                    showToast("Error: Item ID missing.");
                    navigate('sell-to-us', null);
                    return;
                }
                const item = wantedItems.find(i => i.id === data.id);
                if (item) {
                    render(SellFormPage, item);
                } else {
                    showToast("Error: Item not found!");
                    goBack();
                }
            }
        };
        
        const goBack = () => {
            if (navigationStack.length > 1) {
                navigationStack.pop();
                const previousState = navigationStack[navigationStack.length - 1];
                if (previousState) {
                    navigate(previousState.page, previousState.data);
                }
            }
        };

        const addToCart = (productId) => {
            const product = products.find(p => p.id === productId);
            if (product && !cart.find(item => item.id === productId)) {
                cart.push({ ...product });
                updateCartState();
                showToast("Product Added to Cart!");
                return true;
            }
            return false;
        };
        
        const removeFromCart = (productId) => { 
            cart = cart.filter(item => item.id !== productId); 
            updateCartState(); 
        };

        const updateCartState = () => {
            localStorage.setItem('pshStoreCart', JSON.stringify(cart));
            document.getElementById('cart-count').textContent = cart.length;
            if (navigationStack.some(s => s.page === 'cart')) {
                updateCartPage();
            }
        };
        
        const updateCheckoutView = () => {
            const { step } = checkoutState;
            document.querySelectorAll('[id^="checkout-step-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`checkout-step-${step}`).classList.remove('hidden');
            document.querySelectorAll('.step-indicator').forEach((el, index) => {
                if (index + 1 < step) { el.classList.add('active'); el.innerHTML = '✓'; } 
                else if (index + 1 === step) { el.classList.add('active'); el.innerHTML = step; } 
                else { el.classList.remove('active'); el.innerHTML = index + 1; }
            });
            if (step === 3) renderCheckoutStep3();
        };

        const renderCheckoutStep3 = () => {
            const container = document.getElementById('checkout-step-3');
            if(!container) return;
            const methodDetails = paymentDetails[checkoutState.paymentMethod];
            const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            const discountAmount = checkoutState.appliedCoupon ? subtotal * checkoutState.appliedCoupon.discount : 0;
            const total = subtotal - discountAmount;
            const detailKey = methodDetails.address ? 'Address' : 'Number';
            const detailValue = methodDetails.address || methodDetails.number;
            const paymentType = (methodDetails.name === 'bKash' || methodDetails.name === 'Nagad') ? 'Send Money' : 'Transfer';

            container.innerHTML = `
                <h3 class="font-bold text-center mb-4 text-xl">ম্যানুয়াল পেমেন্ট নির্দেশনা</h3>
                <div class="text-left p-4 bg-surface rounded-lg space-y-4">
                    <div class="text-center mb-4">
                        <p class="text-gray-400">মোট পেমেন্ট করতে হবে:</p>
                        <p class="text-4xl font-bold text-primary my-2">$${total.toFixed(2)}</p>
                        ${ checkoutState.appliedCoupon ? `<p class="text-sm text-green-400"> ছাড়: $${discountAmount.toFixed(2)}</p>` : ''}
                    </div>
                    
                    <ul class="text-sm text-gray-300 list-disc list-inside space-y-2">
                        <li>আপনার ${methodDetails.name} অ্যাপ থেকে '${paymentType}' অপশনটি ব্যবহার করুন।</li>
                        <li>নিচের ${detailKey} টি কপি করে সেখানে পেস্ট করুন এবং টাকার পরিমাণ নিশ্চিত করুন।</li>
                        <li>পেমেন্ট সম্পন্ন হলে, আপনি একটি Transaction ID (TrxID) পাবেন।</li>
                        <li>সেই TrxID টি কপি করে নিচের বক্সে পেস্ট করুন।</li>
                    </ul>

                    <div class="my-4 p-3 bg-gray-800 rounded-lg flex justify-between items-center">
                        <span id="payment-info" class="font-mono text-lg break-all">${detailValue}</span>
                        <button id="copy-btn" class="text-sm bg-gray-600 px-3 py-1 rounded-md">কপি</button>
                    </div>
                </div>
                <div class="mt-6">
                    <label class="block mb-1 text-sm text-gray-400">লেনদেনের আইডি (Transaction ID)</label>
                    <input type="text" id="transaction-id" placeholder="এখানে TrxID পেস্ট করুন" class="w-full p-3 rounded-lg bg-surface border border-gray-600">
                </div>
                <button id="confirm-purchase-btn" class="btn-primary w-full mt-6">অর্ডার নিশ্চিত করুন</button>`;
        };
        
        const handleFinalCheckout = async () => {
            const transactionId = document.getElementById('transaction-id')?.value.trim();
            const errorDiv = document.getElementById('checkout-error');
            if (!errorDiv) return;
            errorDiv.classList.add('hidden');

            const trxIdRegex = /^[a-zA-Z0-9]{10}$/; 
            if (!transactionId || !trxIdRegex.test(transactionId)) {
                errorDiv.textContent = "অনুগ্রহ করে একটি সঠিক TrxID দিন (10 characters, letters and numbers only).";
                errorDiv.classList.remove('hidden');
                return;
            }
            
            const btn = document.getElementById('confirm-purchase-btn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Processing...';
            }

            const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            const discountAmount = checkoutState.appliedCoupon ? subtotal * checkoutState.appliedCoupon.discount : 0;
            const total = subtotal - discountAmount;
            const orderDetails = { ...checkoutState.customerInfo, paymentMethod: checkoutState.paymentMethod, transactionId, items: cart.map(item => ({id: item.id, name: item.name, price: item.price})), total, appliedCoupon: checkoutState.appliedCoupon, status: 'Pending', date: new Date().toISOString() };
            
            const ordersCollectionRef = collection(db, `/artifacts/${appId}/public/data/orders`);
            try {
                await addDoc(ordersCollectionRef, orderDetails);

                showToast("Order submitted successfully for review!");
                cart = []; 
                checkoutState.appliedCoupon = null; 
                updateCartState(); 
                
                navigate('home', null);

            } catch(e) { 
                console.error("Checkout Error: ", e);
                let errorMessage = "Could not complete purchase. Please try again.";
                if (e.code === 'permission-denied') {
                    errorMessage = "Purchase failed due to a permission issue. Please check security rules.";
                }
                errorDiv.textContent = errorMessage; 
                errorDiv.classList.remove('hidden');
                if(btn) {
                    btn.disabled = false;
                    btn.textContent = 'অর্ডার নিশ্চিত করুন';
                }
            }
        };

        const handleSellRequestSubmit = async (btn) => {
            const name = document.getElementById('sell-full-name').value.trim();
            const contact = document.getElementById('sell-contact-number').value.trim();
            const details = document.getElementById('sell-item-details').value.trim();
            const itemLink = document.getElementById('sell-item-link').value.trim();
            const errorDiv = document.getElementById('sell-form-error');

            if (!name || !contact || !details) {
                errorDiv.textContent = "অনুগ্রহ করে নাম, যোগাযোগ নম্বর এবং বিবরণ পূরণ করুন।";
                errorDiv.classList.remove('hidden');
                return;
            }
            errorDiv.classList.add('hidden');

            btn.disabled = true;
            btn.textContent = 'জমা হচ্ছে...';

            const requestData = {
                customerName: name,
                customerContact: contact,
                itemCondition: details,
                itemLink: itemLink,
                itemId: btn.dataset.itemId,
                itemName: btn.dataset.itemName,
                itemPrice: parseFloat(btn.dataset.itemPrice),
                status: 'Pending',
                date: new Date().toISOString()
            };

            const requestsCollectionRef = collection(db, `/artifacts/${appId}/public/data/sellRequests`);
            try {
                await addDoc(requestsCollectionRef, requestData);
                showToast("আপনার বিক্রির অনুরোধ সফলভাবে জমা হয়েছে!");
                navigate('home', null);
            } catch (e) {
                console.error("Sell Request Error: ", e);
                errorDiv.textContent = "একটি সমস্যা হয়েছে। আবার চেষ্টা করুন।";
                errorDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'অনুরোধ জমা দিন';
            }
        };

        const showToast = (message) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
        
        const handleSearch = (e) => {
            const term = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            if (!resultsContainer) return;
            if (!term) { resultsContainer.innerHTML = `<div class="text-center text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg><p>Type to find scripts and games.</p></div>`; return; }
            const results = products.filter(p => p.name.toLowerCase().includes(term));
            if(results.length > 0) { resultsContainer.innerHTML = results.map(p => `<div class="product-card cursor-pointer text-left p-3 hover:bg-card rounded-lg flex items-center gap-4" data-id="${p.id}"><img src="${p.image}" class="w-10 h-10 rounded">${p.name}</div>`).join('');
            } else { resultsContainer.innerHTML = `<p class="text-center text-gray-400">No products found for "${term}".</p>`; }
        };

        const handleMyProductsLookup = async () => {
            const email = document.getElementById('my-products-email')?.value.trim();
            const listDiv = document.getElementById('my-products-list');
            if (!listDiv) return;

            if (!email) {
                listDiv.innerHTML = `<p class="text-red-400 text-center">অনুগ্রহ করে আপনার ইমেইল দিন।</p>`;
                return;
            }
            listDiv.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';
            
            const ordersRef = collection(db, `/artifacts/${appId}/public/data/orders`);
            const q = query(ordersRef, where("email", "==", email), where("status", "==", "Completed"));
            
            try {
                const querySnapshot = await getDocs(q);
                const purchasedIds = new Set();
                querySnapshot.forEach((doc) => {
                    const order = doc.data();
                    if (order.items && Array.isArray(order.items)) {
                        order.items.forEach(item => purchasedIds.add(item.id));
                    }
                });

                if (purchasedIds.size === 0) {
                    listDiv.innerHTML = '<p class="text-center text-gray-400">এই ইমেইলে কোনো অনুমোদিত পণ্য পাওয়া যায়নি।</p>';
                    return;
                }

                const userProducts = products.filter(p => purchasedIds.has(p.id));
                listDiv.innerHTML = '<div class="space-y-4">' + userProducts.map(p => {
                    return `<div class="bg-surface p-4 rounded-lg flex items-center gap-4">
                            <img src="${p.image}" alt="${p.name}" class="w-16 h-16 rounded-lg">
                            <div>
                                <h4 class="font-semibold text-lg">${p.name}</h4>
                                ${(p.downloadURL && p.downloadURL.trim() !== '')
                                    ? `<a href="${p.downloadURL}" target="_blank" rel="noopener noreferrer" class="text-sm btn-primary !py-1 !px-3 mt-2 inline-block">Download Access</a>` 
                                    : `<span class="text-sm text-gray-500 mt-1">No file available</span>`
                                }
                            </div>
                        </div>`;
                }).join('') + '</div>';

            } catch (error) {
                console.error("Error fetching user products:", error);
                listDiv.innerHTML = '<p class="text-center text-red-400">An error occurred while fetching your products.</p>';
            }
        };
        
        async function loadInitialData() {
            // Ensure db is initialized before trying to use it
            if (!db) {
                console.log("Firestore not initialized. Aborting data load.");
                return;
            }
            onSnapshot(collection(db, `/artifacts/${appId}/public/data/products`), (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const lastState = navigationStack[navigationStack.length - 1];
                
                if (lastState && (lastState.page === 'home' || lastState.page === 'section')) {
                    navigate(lastState.page, lastState.data);
                }
            });

            onSnapshot(collection(db, `/artifacts/${appId}/public/data/sections`), (snapshot) => {
                sections = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const lastState = navigationStack[navigationStack.length - 1];
                if (lastState && lastState.page === 'home') {
                    renderHomePageSections();
                }
            });
            
            onSnapshot(collection(db, `/artifacts/${appId}/public/data/wantedItems`), (snapshot) => {
                wantedItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 const lastState = navigationStack[navigationStack.length - 1];
                if (lastState && lastState.page === 'sell-to-us') {
                    render(SellToUsPage, wantedItems);
                }
            });

            onSnapshot(doc(db, `/artifacts/${appId}/public/data/settings`, "banner"), (doc) => {
                 if (doc.exists()) bannerSettings = doc.data();
                 const lastState = navigationStack[navigationStack.length - 1];
                 if(lastState && lastState.page === 'home') navigate('home', null);
            });
        }

        function initializeEventListeners() {
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                
                if (target.closest('#home-btn')) { navigate('home', null); return; }
                if (target.closest('#cart-btn')) { navigate('cart', null); return; }
                if (target.closest('#my-products-button')) { navigate('my-products', null); return; }
                if (target.closest('#sell-to-us-button')) { navigate('sell-to-us', null); return; }

                if (target.closest('#search-icon')) {
                    mainContent.classList.toggle('hidden'); 
                    searchSection.classList.toggle('hidden'); 
                    if(!searchSection.classList.contains('hidden')) searchInput.focus(); 
                    else { searchInput.value = ''; handleSearch({target: {value: ''}}); }
                    return;
                }

                const productCard = target.closest('.product-card');
                if (productCard) {
                    navigate('product-detail', { id: productCard.dataset.id });
                    return;
                }
                const viewAllBtn = target.closest('.view-all-btn');
                if(viewAllBtn) {
                    const sectionId = viewAllBtn.dataset.sectionId;
                    const sectionName = viewAllBtn.dataset.sectionName;
                    navigate('section', { id: sectionId, name: sectionName });
                    return;
                }
                if (target.closest('.back-btn')) { goBack(); return; }
                const addToCartBtn = target.closest('.add-to-cart-btn');
                if (addToCartBtn) { addToCart(addToCartBtn.dataset.id); return; }
                const buyNowBtn = target.closest('.buy-now-btn');
                if (buyNowBtn) { if (addToCart(buyNowBtn.dataset.id)) navigate('cart', null); return; }
                const sellNowBtn = target.closest('.sell-now-btn');
                if (sellNowBtn) {
                    const itemId = sellNowBtn.dataset.id;
                    navigate('sell-form', { id: itemId });
                    return;
                }
                 if (target.closest('#submit-sell-request-btn')) {
                    handleSellRequestSubmit(target.closest('#submit-sell-request-btn'));
                    return;
                }
                if (target.closest('.remove-from-cart-btn')) { removeFromCart(target.closest('.remove-from-cart-btn').dataset.id); return; }
                if (target.closest('#proceed-to-checkout-btn')) { navigate('checkout', null); return; }
                if (target.closest('#find-my-products-btn')) { handleMyProductsLookup(); return; }


                if (target.closest('#checkout-next-1')) {
                    const name = document.getElementById('full-name').value, email = document.getElementById('email').value, errorDiv = document.getElementById('checkout-error');
                    if (!name || !email) { errorDiv.textContent = "অনুগ্রহ করে আপনার নাম এবং ইমেইল দিন।"; errorDiv.classList.remove('hidden'); return; }
                    errorDiv.classList.add('hidden');
                    checkoutState.customerInfo = { name, email }; checkoutState.step = 2; updateCheckoutView();
                    return;
                }
                if (target.closest('#apply-coupon-btn')) {
                    const code = document.getElementById('coupon-code').value.toUpperCase();
                    const msgEl = document.getElementById('coupon-message');
                    if (code === (bannerSettings.coupon || "").toUpperCase()) {
                        checkoutState.appliedCoupon = { code, discount: 0.10 };
                        msgEl.textContent = `10% discount applied!`;
                        msgEl.className = 'text-sm mt-2 text-green-400';
                    } else {
                        checkoutState.appliedCoupon = null;
                        msgEl.textContent = 'Invalid coupon code.';
                        msgEl.className = 'text-sm mt-2 text-red-400';
                    }
                    return;
                }
                const paymentOption = target.closest('.payment-option');
                if (paymentOption) {
                    document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
                    paymentOption.classList.add('selected');
                    checkoutState.paymentMethod = paymentOption.dataset.method;
                    return;
                }
                if (target.closest('#checkout-next-2')) {
                    const errorDiv = document.getElementById('checkout-error');
                    if (!checkoutState.paymentMethod) { errorDiv.textContent = "অনুগ্রহ করে একটি পেমেন্ট পদ্ধতি বাছাই করুন।"; errorDiv.classList.remove('hidden'); return; }
                    errorDiv.classList.add('hidden'); checkoutState.step = 3; updateCheckoutView();
                    return;
                }
                if (target.closest('#copy-btn')) {
                    navigator.clipboard.writeText(document.getElementById('payment-info').innerText).then(() => showToast("কপি করা হয়েছে!"));
                    return;
                }
                if (target.closest('#confirm-purchase-btn')) {
                    handleFinalCheckout();
                    return;
                }
            });

            searchInput.oninput = handleSearch;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!db || !auth) {
                console.error("Firebase services not initialized.");
                return;
            }

            // Sign in anonymously to allow database write operations
            signInAnonymously(auth)
                .then(() => {
                    console.log('User signed in anonymously.');
                    
                    // Once signed in, proceed with the app logic
                    cart = JSON.parse(localStorage.getItem('pshStoreCart') || '[]');
                    initializeEventListeners();
                    navigate('home', null);
                    loadInitialData();
                    updateCartState();
                })
                .catch((error) => {
                    console.error("Error signing in anonymously:", error);
                    document.getElementById('initial-error').textContent = "প্রমাণীকরণ ব্যর্থ হয়েছে। আবার চেষ্টা করুন।";
                    document.getElementById('initial-error').classList.remove('hidden');
                });
        });
    </script>
</body>
</html>


